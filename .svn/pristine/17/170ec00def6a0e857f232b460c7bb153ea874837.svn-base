<?php
// 本类由系统自动生成，仅供测试用途
class UsrAction extends Action {



	
	public function regist(){

		$wechatId=$_GET['openid'];
		$headImgUrl='http://'.str_replace('-gang-','/',$_GET['headimgurl']);
		$nickname=$_GET['nickname'];

		$url=C('javaback').'/carModel/brand.action';
		$json=https_request($url);
		$arr=json_decode($json,true);
		$carBrandls=$arr['data'];
		foreach ($carBrandls as $carBrandv) {
			
			$arrnw=array(
				'carBrand'=>$carBrandv,
				);
			array_push($carBrandlsnw, $arrnw);
		}
		
		$this->assign('carBrandls',$carBrandls);

		

		$this->assign('wechatId',$wechatId);
		$this->assign('headImgUrl',$headImgUrl);
		$this->assign('nickname',$nickname);
		$this->display('regist');
	}

	public function getcarmodel(){
		$carBrand=$_POST['carBrand'];

		if($carBrand=='B'){
			$carBrand='BYD';
		}else if($carBrand=='T'){
			$carBrand='TESLA';
		}

		$url=C('javaback').'/carModel/brandModel.action?brand='.$carBrand;
		$json=https_request($url);
		$arr=json_decode($json,true);
		$carModells=$arr['data'];
		$str="<option value='0'>选择车型号</option>";
		foreach ($carModells as $carModelv) {
			$tmp=explode('_',$carModelv);
			$str=$str."<option value='".$tmp[1]."'>".$tmp[0]."</option>";
		}
		$data['opts']=$str;
		$this->ajaxReturn($data,'json');
	}

	public function doregist(){
		
		$url=C('javaback').'/user/init.action';
		
		$dt=$_POST;
		
		$url=$url.'?wechatId='.$dt['wechatId'].'&headImgUrl='.$dt['headImgUrl'].'&nickName='.$dt['nickName'].'&mobile='.$dt['mobile'].'&carBrand='.$dt['carBrand'].'&carModelId='.$dt['carModelId'].'&carNo='.$dt['carNo'];
		

		$json=https_request($url);
		$arr=json_decode($json,true);

		if($arr['code']=='A00000'){
			session('openid',$dt['wechatId']);
		}

		$msg=$arr['msg'];

		
		$data['msg']=$msg;
		$data['url']=__URL__.'/'.$_GET['x'];

		$this->ajaxReturn($data,'json');
	}

	public function usrct(){
		import('@.SS.SSAction');
		$ss = new SSAction();
		$usrdto=$ss->setss();

		$url=C('javaback').'/device/getByOwner.action?wechatId='.session('openid');
		$json=https_request($url);
		// $json='{"data": [{"id":1,"owner":1,"sn":"001","model":1,"city":null,"longitude":"121.572673","latitude":"31.212916","address":" 我的位 置","peripheral":null,"ip":null,"serverIp":null,"serverPort":null,"pic":"","battery":0,"status":""}, {"id":6,"owner":1,"sn":"006","model":1,"city":null,"longitude":"121.581845","latitude":"31.219382","address":" 汤臣湖庭花园 桩","peripheral":null,"ip":null,"serverIp":null,"serverPort":null,"pic":"","battery":0,"status":""}, {"id":8,"owner":1,"sn":"008","model":1,"city":null,"longitude":"121.506252","latitude":"31.245374","address":" 上海东方明珠电视塔 桩","peripheral":null,"ip":null,"serverIp":null,"serverPort":null,"pic":"","battery":0,"status":""}],"code":"A00000","msg":" 获取设备成功"}';
		$arr=json_decode($json,true);
		$dvcls=$arr['data'];
		$dvclsnw=array();
		foreach($dvcls as $dvcv){
			if($dvcv['status']==''||$dvcv['status']=='02'){
				$dvcv['stts']='off';
			}else{
				$dvcv['stts']='on';
			}
			array_push($dvclsnw, $dvcv);
		}
		$this->assign('dvcls',$dvclsnw);

		$url=C('javaback').'/order/getOrderPage.action?wechatId='.session('openid');
		$json=https_request($url);
		$arr=json_decode($json,true);
		$this->assign('aals',$arr['data']['results']);

		import('@.WX.JssdkAction');
		$jssdk = new JssdkAction(C('appid'), C('appsecret'));
		$signPackage = $jssdk->GetSignPackage();
		$this->assign('spkg',$signPackage);

		$this->assign('ttl','个人中心');
		$this->display('usrct');
	}

	public function chongzhi(){
		$this->assign('ttl','充值');
		$this->display('chongzhi');
	}

	public function dochongzhi(){
		$money=$_POST['money'];
		$url=__ROOT__.'/wxpay/example/jsapi.php?money='.$money;
		$data['url']=$url;
		$this->ajaxReturn($data,'json');
	}

	public function doonoffdvc(){
		$dvcid=$_GET['dvcid'];
		$tm=$_GET['tm'];
		$oprt=$_GET['oprt'];
		$openid=session('openid');

		$str='';
		if($tm!=''){
			$tm=str_replace(' ', '+', $tm);//curl无法解析url的，所以要手动把参数改变下
			$str='&time='.$tm;
		}

		$url=C('javaback').'/device/operate.action?deviceId='.$dvcid.'&wechatId='.$openid.'&operation='.$oprt.$str;
		$json=https_request($url);
		$arr=json_decode($json,true);
		if($arr['code']=='A00000'){
			$data['rslt']='ok';
		}else{
			$data['rslt']='error';
		}
		
		$data['msg']=$arr['msg'];
		


		$this->ajaxReturn($data,'json');
	}
	
	public function fnddvcbydvcid(){
		$dvcid=$_GET['dvcid'];
		$url='http://120.26.80.165/device/get.action?deviceId='.$dvcid;
		$json=https_request($url);
		// $json='{"data": {"id":2,"owner":2,"sn":"002","model":1,"city":null,"longitude":"121.575215","latitude":"31.203762","address":" 龙沟新苑 桩","peripheral":null,"ip":null,"serverIp":null,"serverPort":null,"pic":"","battery":0,"status":""},"code":"A00000","msg":" 获取设备成功"}';
		$arr=json_decode($json,true);
		$data['dvco']=$arr['data'];
		$this->ajaxReturn($data,'json');
	}

	public function dosttm(){
		$optm=$_GET['optm'];
		$clstm=$_GET['clstm'];
		$dvcid=$_GET['dvcid'];
		$openid=session('openid');
		
		$flg=1;
		$rslt='';
		if($optm){
			
			$url=C('javaback').'/device/operate.action?deviceId='.$dvcid.'&wechatId='.$openid.'&operation=on&time='.$optm;
			$json=https_request($url);
			$arr=json_decode($json,true);
			if($arr['code']!='A00000'){
				$flg=0;
				$rlst=$rlst.' '.$arr['msg'];
			}
		}
		if($clstm){
			
			$url=C('javaback').'/device/operate.action?deviceId='.$dvcid.'&wechatId='.$openid.'&operation=off&time='.$clstm;
			$json=https_request($url);
			$arr=json_decode($json,true);
			if($arr['code']!='A00000'){
				$flg=0;
				$rlst=$rlst.' '.$arr['msg'];
			}
		}
		$data['flg']=$flg;
		if($flg==0){
			//失败就啥都别管了，照旧
			
			$data['rslt']=$rlst;
		}else{
			//成功就要考虑到很多
			
			$data['rslt']='设置成功';
		}
		//获取最终的桩的状态
		$url=C('javaback').'/device/get.action?deviceId='.$dvcid;
		$json=https_request($url);
		// $json='{"data": {"id":2,"owner":2,"sn":"002","model":1,"city":null,"longitude":"121.575215","latitude":"31.203762","address":" 龙沟新苑 桩","peripheral":null,"ip":null,"serverIp":null,"serverPort":null,"pic":"","battery":0,"status":""},"code":"A00000","msg":" 获取设备成功"}';
		
		$arr=json_decode($json,true);
		//假设最终状态是启用了
		$data['fnlstat']=1;

		$this->ajaxReturn($data,'json');
	}

}