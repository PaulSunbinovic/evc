<?php
// 本类由系统自动生成，仅供测试用途
class UsrAction extends Action {



	
	public function regist(){

		$wechatId=$_GET['openid'];
		$headImgUrl='http://'.str_replace('-gang-','/',$_GET['headimgurl']);
		$nickname=$_GET['nickname'];

		$url=C('javaback').'/carModel/brand.action';
		$json=https_request($url);
		$arr=json_decode($json,true);
		$carBrandls=$arr['data'];
		foreach ($carBrandls as $carBrandv) {
			
			$arrnw=array(
				'carBrand'=>$carBrandv,
				);
			array_push($carBrandlsnw, $arrnw);
		}
		
		$this->assign('carBrandls',$carBrandls);

		

		$this->assign('wechatId',$wechatId);
		$this->assign('headImgUrl',$headImgUrl);
		$this->assign('nickname',$nickname);
		$this->display('regist');
	}

	public function getcarmodel(){
		$carBrand=$_POST['carBrand'];

		if($carBrand=='B'){
			$carBrand='BYD';
		}else if($carBrand=='T'){
			$carBrand='TESLA';
		}

		$url=C('javaback').'/carModel/brandModel.action?brand='.$carBrand;
		$json=https_request($url);
		$arr=json_decode($json,true);
		$carModells=$arr['data'];
		$str="<option value='0'>选择车型号</option>";
		foreach ($carModells as $carModelv) {
			$tmp=explode('_',$carModelv);
			$str=$str."<option value='".$tmp[1]."'>".$tmp[0]."</option>";
		}
		$data['opts']=$str;
		$this->ajaxReturn($data,'json');
	}

	public function doregist(){
		
		$url=C('javaback').'/user/init.action';
		
		$dt=$_POST;
		
		$url=$url.'?wechatId='.$dt['wechatId'].'&headImgUrl='.$dt['headImgUrl'].'&nickName='.$dt['nickName'].'&mobile='.$dt['mobile'].'&carBrand='.$dt['carBrand'].'&carModelId='.$dt['carModelId'].'&carNo='.$dt['carNo'];
		

		$json=https_request($url);
		$arr=json_decode($json,true);

		if($arr['code']=='A00000'){
			session('openid',$dt['wechatId']);
		}

		$msg=$arr['msg'];

		
		$data['msg']=$msg;
		$data['url']=__URL__.'/'.$_GET['x'];

		$this->ajaxReturn($data,'json');
	}

	public function usrct(){
		import('@.SS.SSAction');
		$ss = new SSAction();
		$usrdto=$ss->setss();

		$url=C('javaback').'/device/getByOwner.action?wechatId='.session('openid');
		$json=https_request($url);
		$arr=json_decode($json,true);
		$dvcls=$arr['data'];
		$dvclsnw=array();
		foreach($dvcls as $dvcv){
			if($dvcv['status']==''||$dvcv['status']=='02'){
				$dvcv['stts']='off';
			}else{
				$dvcv['stts']='on';
			}
			array_push($dvclsnw, $dvcv);
		}
		$this->assign('dvcls',$dvclsnw);

		$url=C('javaback').'/order/getOrderPage.action?wechatId='.session('openid');
		$json=https_request($url);
		$arr=json_decode($json,true);
		$this->assign('aals',$arr['data']['results']);

		import('@.WX.JssdkAction');
		$jssdk = new JssdkAction(C('appid'), C('appsecret'));
		$signPackage = $jssdk->GetSignPackage();
		$this->assign('spkg',$signPackage);

		$this->assign('ttl','个人中心');
		$this->display('usrct');
	}

	public function chongzhi(){
		$this->assign('ttl','充值');
		$this->display('chongzhi');
	}

	public function dochongzhi(){
		$money=$_POST['money'];
		$url=__ROOT__.'/wxpay/example/jsapi.php?money='.$money;
		$data['url']=$url;
		$this->ajaxReturn($data,'json');
	}

	public function doonoffdvc(){
		$dvcid=$_GET['dvcid'];
		$tm=$_GET['tm'];
		$oprt=$_GET['oprt'];
		$openid=session('openid');

		$str='';
		if($tm!=''){
			$str='&time='.$tm;
		}

		$url=C('javaback').'/device/operate.action?deviceId='.$dvcid.'&wechatId='.$openid.'&operation='.$oprt.$str;
		$json=https_request($url);
		$arr=json_decode($json,true);
		if($arr['code']=='A00000'){
			$data['rslt']='ok';
		}else{
			$data['rslt']='error';
		}
		
		$data['msg']=$arr['msg'];
		


		$this->ajaxReturn($data,'json');
	}
	

}