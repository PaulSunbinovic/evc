<?php
// 本类由系统自动生成，仅供测试用途
class IndexAction extends Action {



	public function test(){
		p($_POST);die;
	}


    public function index(){

    	import('@.WX.JssdkAction');
		$jssdk = new JssdkAction(C('appid'), C('appsecret'));
		$signPackage = $jssdk->GetSignPackage();
		$this->assign('spkg',$signPackage);

		// $url="http://api.map.baidu.com/geosearch/v3/nearby?ak=S0VAW4LjQirp9FUmXF08Zvdy&geotable_id=116349&location=120.363991,30.32658&radius=1000";
		// $result=https_request($url);
		// $array=json_decode($result,TRUE);


		// $this->assign('cdzls',$array['contents']);
		// ojxMBuJe07gSZDUwp0ZHGHEMHOR8
		// --------------------------为了有用户进行测试我就牺牲下拿我到微信号来测了
		session('openid','12345');
		$openid=session('openid');
		import('@.SS.SSAction');
		$ss = new SSAction();
		$usrdto=$ss->setss();

		


		$lth=$_GET['lth'];
		if($lth==1000){
			$lvl=15;
		}else if($lth==2500){
			$lvl=14;
		}else if($lth==5000){
			$lvl=13;
		}else if($lth==10000){
			$lvl=12;
		}else if($lth=='all'){
			$lvl=11;
		}else{//默认
			$lvl=15;
		}
		$this->assign('lvl',$lvl);
		$this->assign('tbid',C('tbid'));

		$this->display('index');
	}

	

	public function doapnt(){

		if($_GET['tp']=='ok'){//type onekey//一键获取点的话，需要算出最近点，然后产生订单
			//到时看马哥是不是给算出最近的点，我现在先假定我已经得到了
			$mstnr='{"id":4,"owner":2,"sn":"004","model":1,"city":null,"longitude":"121.570077","latitude":"31.219745","address":"上海浦东嘉里大酒店桩","peripheral":null,"ip":null,"serverIp":null,"serverPort":null,"pic":"","battery":0,"status":""}';//most near
			$apntpnt=json_decode($mstnr,true);
			
		}else{//普通的话就需要直接获得装ID根据桩id 来进行
			//...一个GET桩ID的过程我就暂时省去了，反正最终也是获得预约桩的代码
			$mstnr='{"id":4,"owner":2,"sn":"004","model":1,"city":null,"longitude":"121.570077","latitude":"31.219745","address":"上海浦东嘉里大酒店桩","peripheral":null,"ip":null,"serverIp":null,"serverPort":null,"pic":"","battery":0,"status":""}';//most near
			$apntpnt=json_decode($mstnr,true);
		}

		//反正不管是怎样都能拿到预约点

    	//先试着预约下
    	$url=C('javaback').'/order/appoint.action?wechatId='.session('openid').'&carId='.$_GET['crid'].'&deviceId='.$apntpnt['id'];
    	$json=https_request($url);
    	$arr=json_decode($json,true);
    	if($arr['code']=='A01406'){
    		$rslt='hsodr';
    	}else if($arr['code']=='A01407'){
    		$rslt='hsbtm';
    	}else if($arr['code']=='A01408'){
    		$rslt='hsgp';
    	}else if($arr['code']=='A00000'){
    		$rslt='admt';
    	}$rslt='admt';
    	//hsodr  hsgp(区间) hsbtm(到底了) admt（允许预约） 
    	//假设得到结果是有单子需要删除
    	$data['rslt']=$rslt;
    	if($rslt=='hsodr'){//获得什么订单 订单的里面设备的ID是哪个
    		//甭管咋样，你既然要约，之前的东西必须清
	    	$url='http://120.26.80.165/order/getLastOrder.action&wechatId=12345';
	    	$json=https_request($url);
	    	$arr=json_decode($json,true);
    		//这里假定一个单子？查最近的单子
    		$json='{"id":1,"userId":1,"macId":null,"deviceId":2,"price":200,"startDegree":null,"endDegree":null,"carId":1,"status":0,"totalPrice":null,"createTime":"2015-09-20 11:43:16","updateTime":"2015-09-20 11:43:16","endTime":null,"version":0,"statusFinal":false}';
    		$odr=json_decode($json,true);
    		$data['odr']=$odr;
    		//根据订单里的dvcid获取桩信息？
    		$json='{"id":4,"owner":2,"sn":"004","model":1,"city":null,"longitude":"121.570077","latitude":"31.219745","address":"上海浦东嘉里大酒店桩","peripheral":null,"ip":null,"serverIp":null,"serverPort":null,"pic":"","battery":0,"status":""}';//most near
			$odrpnt=json_decode($json,true);
			$data['odrpnt']=$odrpnt;
    	}else if($rslt=='hsgp'){
    		//这里需要计算还有多少时间可以充电?这里直接就是5小时//mny?dvcid?tm?
    		$mny=8;
    		$tm=5;
    		$dvcid=$apntpnt['id'];
    		$data['mny']=$mny;
    		$data['tm']=$tm;
    		$data['dvcid']=$dvcid;
    	}else if($rslt=='hsbtm'){

    	}else if($rslt=='admt'){
    		
			
			$data['apntpnt']=$apntpnt;
			
    	}
		
    	$this->ajaxReturn($data,'json');
		

		
	}

	function docnclodr(){
		$url='http://120.26.80.165/order/appointCancel.action?id=111';
		$json=https_request($url);
		$arr=json_decode($json,true);
		$data['msg']=$arr['msg'];
	}

	function dofnddvcls(){
		$url=C('javaback').'/device/getByAddr.action?addr='.$_GET['ctt'];
		if(session('openid')){
			$openid=session('openid');
			import('@.SS.SSAction');
			$ss = new SSAction();
			$usrdto=$ss->setss();
			$str='&carModelId'.$usrdto['carList'][0]['carModelId'];
			$url=$url.$str;
		}
		$json=https_request($url);
		$arr=json_decode($json,true);
		$data['dvcls']=$arr['data'];
		$this->ajaxReturn($data,'json');
	}



}